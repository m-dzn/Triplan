<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="layout/layout">

<div layout:fragment="content">
    <section class="margin-section">
        <th:block th:replace="fragment/title :: title_2('ÏúÑÏãú Î¶¨Ïä§Ìä∏')"></th:block>

        <!--Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÉ≠-->
        <ul class="nav nav-tabs margin-bottom-40">
            <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="#">ÏàôÏÜå</a>
            </li>
            </li>
        </ul>
        <!--Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÉ≠ ÎÅù-->

        <!--Ïπ¥Îìú ÏóÜÏùÑ Îïå-->
        <div id="wishNull">
        </div>
        <!--Ïπ¥Îìú ÏóÜÏùÑ Îïå ÎÅù-->

        <!--ÏòàÏãúÏö© Ïπ¥Îìú-->

        <div class="d-flex flex-wrap" id="wishlist-card-container">
        </div>

        <!--ÏòàÏãúÏö© Ïπ¥Îìú ÎÅù-->

    </section>

    <!--ÌéòÏù¥ÏßÄ-->
    <nav class="margin-top-16" aria-label="Page navigation example">
        <ul class="pagination pagination-sm justify-content-end" id="wishlistPagingBtnGroup">
        </ul>
    </nav>
    <!--ÌéòÏù¥ÏßÄ ÎÅù-->

</div>
<th:block layout:fragment="script">
</th:block>
</html>
<script>
    // HTML ÌÉúÍ∑∏Í∞Ä Î™®Îëê Î°úÎìúÎêú ÌõÑ Ïã§Ìñâ
    document.addEventListener("DOMContentLoaded", function() {
        var DEFAULT_PAGE_SIZE = 10;

        // Îç∞Ïù¥ÌÑ∞Î•º Îã¥ÏùÑ ÌÉúÍ∑∏Î•º ÏÑ†ÌÉùÏûêÎ°ú Í∞ÄÏ†∏Ïò§Îäî ÏòÅÏó≠
        var wishlistTable = document.getElementById("wishlistTable");
        var wishlistPagingBtnGroup = document.getElementById("wishlistPagingBtnGroup");

        var wishNull = document.getElementById("wishNull");

        var url = new URL(location.href);
        var currentPage = url.searchParams.get("currentPage") || 1;
        var pageSize = url.searchParams.get("pageSize") || DEFAULT_PAGE_SIZE;

        fetchMemberWishlist(pageSize, currentPage);
    });

    function removeWishlist(wishlistId, pageSize, currentPage) {
        if (confirm('Ï†ïÎßê Ï†úÍ±∞ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
            fetch(`${BASE_URL}/api/wishlists/${wishlistId}`, {
                method: 'DELETE'
            }).then(response => {
                if (response.ok) {
                    return;
                }
            }).then(() => fetchMemberWishlist(pageSize, currentPage));
        }
    }

    function fetchMemberWishlist(pageSize, currentPage) {
        // ÎπÑÎèôÍ∏∞ AJAX ÌÜµÏã†ÏúºÎ°ú DB Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò§Îäî ÏòÅÏó≠
        fetch(`${BASE_URL}/api/wishlists?currentPage=${currentPage}&pageSize=${pageSize}`, {
            method: 'GET'
        }).then(response => {
            // Îç∞Ïù¥ÌÑ∞ Ï†ÑÏ≤òÎ¶¨
            if (response.ok) {
                return response.json();
            }
        }).then(wishlistPagination => {
            // Ïã§Ï†ú ÌîÑÎ°†Ìä∏ Î°úÏßÅÏù¥ Îì§Ïñ¥Í∞à ÏòÅÏó≠
            // ÌÉúÍ∑∏ ÏóòÎ¶¨Î®ºÌä∏Ïóê Îç∞Ïù¥ÌÑ∞Î•º Î∂ôÏó¨Ï£ºÎ©¥ Îê®

            var totalPages = wishlistPagination.totalPages;

            if (currentPage > totalPages) {
                location.href = `${location.origin}${location.pathname}?pageSize=${pageSize}&currentPage=${totalPages}`;
            }

            var wishlistCardContainer = document.getElementById("wishlist-card-container");

            var wishlistCardList = [];

            if(wishlistPagination.list.length < 1){

                wishNull.innerHTML =
                    `<div class="d-flex justify-content-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" fill="currentColor"
                         class="color-gray bi bi-calendar-x" viewBox="0 0 16 16">
                        <path
                            d="M6.146 7.146a.5.5 0 0 1 .708 0L8 8.293l1.146-1.147a.5.5 0 1 1 .708.708L8.707 9l1.147 1.146a.5.5 0 0 1-.708.708L8 9.707l-1.146 1.147a.5.5 0 0 1-.708-.708L7.293 9 6.146 7.854a.5.5 0 0 1 0-.708z"/>
                        <path
                            d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
                    </svg>
                </div>

                <div class="d-flex justify-content-center margin-top-24">
                    <span class="color-gray font-size-20">Î™©Î°ùÏù¥ ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§.</span>
                </div>`;
            }

            wishlistPagination.list.forEach((wishlist) => {
                wishlistCardList.push(`<div class="card flex-shrink-0 mb-4" id="card">
                                    <img src="${wishlist.itemImg}" class="card-img-top" id="detail-card-img">
                                    <div class="card-body p-2">
                                        <div class="row m-0 p-0 h-100 d-flex align-content-between">
                                            <div class="row m-0 p-0 d-flex justify-content-between">
                                                <div class="col-auto">${wishlist.name}</div>
                                            </div>
                                            <div class="row m-0 p-0">
                                                <div class="col-auto">${wishlist.location}</div>
                                            </div>
                                            <div class="row m-0 p-0 d-flex justify-content-between">
                                                <div class="col-auto">Î≥ÑÏ†ê</div>
                                                <div class="col-auto">
                                                    <button name="wish" id="heart" type="checkbox" onclick="removeWishlist(${wishlist.wishlistId}, ${pageSize}, ${currentPage})"></button>
                                                    <label for="heart">üñ§</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>`);
            });

            wishlistCardContainer.innerHTML = wishlistCardList.join("");

            var commonPath = "/wishlist";

            // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò ÏΩîÎìú Îì§Ïñ¥Í∞à Í≥≥
            var _html = `
                    <li class="page-item ${wishlistPagination.hasPrev ? '' : 'disabled'}">
                        <a class="page-link" href="${commonPath}?currentPage=${wishlistPagination.startPage - 1}&pageSize=${pageSize}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>`;

            for (var i = wishlistPagination.startPage; i <= wishlistPagination.endPage; i++) {
                _html += `<li class="page-item ${currentPage == i ? 'active' : ''}"><a class="page-link" href="${commonPath}?currentPage=${i}&pageSize=${pageSize}">${i}</a></li>`;
            }

            _html += `
                    <li class="page-item ${wishlistPagination.hasNext ? '' : 'disabled'}">
                        <a class="page-link" href="${commonPath}?currentPage=${wishlistPagination.endPage + 1}&pageSize=${pageSize}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>`;
            wishlistPagingBtnGroup.innerHTML = _html;
        });

    };
</script>